import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot } from 'firebase/firestore';
import { X, CheckCircle, Circle, Plus, Trash2, Loader, Calendar, User, AlertTriangle } from 'lucide-react';

// --- FIREBASE SETUP ---
// Global variables provided by the environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The collection path for private user data (tasks)
const TASKS_DOC_PATH = `/artifacts/${appId}/users/`;
const TASKS_DOC_ID = 'weekly_tasks';

const WEEKDAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

// Utility function for generating simple unique IDs
const generateId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

const App = () => {
  
  // Use useMemo to safely define the initial structured state for all days
  const initialTasksState = useMemo(() => {
    return WEEKDAYS.reduce((acc, day) => ({ ...acc, [day]: [] }), {});
  }, []);

  // --- STATE ---
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  // Initialize tasks with the correct structure immediately
  const [tasks, setTasks] = useState(initialTasksState); 
  const [currentDay, setCurrentDay] = useState(WEEKDAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1]);
  const [newTaskText, setNewTaskText] = useState('');
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [firebaseError, setFirebaseError] = useState(null);

  // --- FIREBASE INITIALIZATION & AUTH ---
  useEffect(() => {
    let authSubscription;
    
    try {
      if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey) {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);
        setDb(firestore);
        setAuth(firebaseAuth);

        authSubscription = onAuthStateChanged(firebaseAuth, (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            // Sign in anonymously or with custom token
            const signInPromise = initialAuthToken
              ? signInWithCustomToken(firebaseAuth, initialAuthToken)
              : signInAnonymously(firebaseAuth);

            signInPromise
              .then((userCredential) => {
                setUserId(userCredential.user.uid);
              })
              .catch((error) => {
                console.error("Firebase Auth Error:", error);
                setFirebaseError(`Authentication failed: ${error.code}`);
                // Fallback userId is set below to ensure loading stops
                setUserId(crypto.randomUUID());
              })
              .finally(() => {
                  // Crucial: Ensure readiness is always set regardless of auth success/fail
                  setIsAuthReady(true);
              });
          }
        });
      } else {
        // Fallback for non-Firebase environment
        console.warn("Firebase config missing or incomplete. Using local state.");
        setFirebaseError("Firebase config is missing or invalid. Data will not persist.");
        setUserId('local-user'); // Set local userId
        setIsAuthReady(true); // Stop auth loading
      }
    } catch (e) {
      console.error("Initialization failed:", e);
      setFirebaseError(`Initialization failed: ${e.message}`);
      setUserId(crypto.randomUUID());
      setIsAuthReady(true); // Stop auth loading
    }
    
    // Cleanup for onAuthStateChanged
    return () => {
        if (authSubscription) {
            authSubscription();
        }
    };
  }, [initialTasksState]); // initialTasksState is constant, safe dependency

  // --- FIRESTORE DATA LISTENER (onSnapshot) ---
  useEffect(() => {
    // Only proceed if auth process is complete and a userId is determined
    if (!isAuthReady || !userId) {
        return;
    }

    // Handle local user fallback immediately
    if (userId === 'local-user') {
        // Tasks are already initialized via useState(initialTasksState)
        setLoading(false); 
        return;
    }
    
    // Handle Firebase user
    if (db) {
        const docRef = doc(db, TASKS_DOC_PATH + userId, TASKS_DOC_ID);

        const unsubscribe = onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const fetchedTasks = docSnapshot.data();
                // Merge fetched data with the initial structured state to ensure all days are present
                const mergedTasks = WEEKDAYS.reduce((acc, day) => {
                    acc[day] = fetchedTasks[day] || [];
                    return acc;
                }, {});
                setTasks(mergedTasks);
            } else {
                // Document does not exist: use initial state and create the doc
                setTasks(initialTasksState);
                setDoc(docRef, initialTasksState, { merge: true }).catch(err => {
                    console.error("Error creating doc:", err);
                    setFirebaseError(`Could not create initial document: ${err.message}`);
                });
            }
            setLoading(false); // Crucial: Stop loading once data is retrieved or initialized
        }, (error) => {
            console.error("Error listening to tasks:", error);
            setFirebaseError(`Real-time listener failed: ${error.message}`);
            setLoading(false);
        });

        // Cleanup function to stop listening when the component unmounts
        return () => unsubscribe();
    }
  }, [db, userId, isAuthReady, initialTasksState]);


  // --- FIRESTORE WRITE OPERATIONS ---

  const updateDatabase = useCallback(async (newTasksState) => {
    // Prevent DB writes if in local mode or not ready
    if (!db || !userId || userId === 'local-user' || !isAuthReady) {
      console.warn("Database not ready or local mode. State updated locally.");
      setTasks(newTasksState);
      return;
    }

    setSaving(true);
    const docRef = doc(db, TASKS_DOC_PATH + userId, TASKS_DOC_ID);

    try {
      // Use setDoc to replace the entire map for simplicity and consistency
      await setDoc(docRef, newTasksState);
    } catch (error) {
      console.error("Error updating tasks:", error);
      setFirebaseError(`Failed to save task: ${error.message}`);
    } finally {
      setSaving(false);
    }
  }, [db, userId, isAuthReady]);

  // --- HANDLERS (Simplified for brevity, calling updateDatabase) ---

  const handleAddTask = (e) => {
    e.preventDefault();
    if (!newTaskText.trim()) return;

    const newTask = {
      id: generateId(),
      text: newTaskText.trim(),
      completed: false,
    };

    const newTasksState = {
      ...tasks,
      [currentDay]: [...(tasks[currentDay] || []), newTask],
    };

    updateDatabase(newTasksState);
    setNewTaskText('');
  };

  const handleToggleCompletion = (taskId) => {
    const dayTasks = tasks[currentDay];
    if (!dayTasks) return;

    const newDayTasks = dayTasks.map(task =>
      task.id === taskId ? { ...task, completed: !task.completed } : task
    );

    const newTasksState = {
      ...tasks,
      [currentDay]: newDayTasks,
    };

    updateDatabase(newTasksState);
  };

  const handleDeleteTask = (taskId) => {
    const dayTasks = tasks[currentDay];
    if (!dayTasks) return;

    const newDayTasks = dayTasks.filter(task => task.id !== taskId);

    const newTasksState = {
      ...tasks,
      [currentDay]: newDayTasks,
    };

    updateDatabase(newTasksState);
  };

  // currentTasks relies on 'tasks' being initialized correctly, which it now is.
  const currentTasks = useMemo(() => tasks[currentDay] || [], [tasks, currentDay]);

  // --- UI COMPONENTS ---

  const TaskItem = ({ task }) => (
    <div
      className="flex items-center justify-between p-3 mb-2 bg-white rounded-lg shadow transition duration-150 ease-in-out hover:shadow-md"
      key={task.id}
    >
      <div className="flex items-center flex-1 min-w-0">
        <button
          onClick={() => handleToggleCompletion(task.id)}
          className={`mr-3 p-1 rounded-full transition-colors ${task.completed ? 'text-green-500 hover:text-green-600' : 'text-gray-400 hover:text-indigo-500'}`}
        >
          {task.completed ? <CheckCircle size={20} fill="currentColor" /> : <Circle size={20} />}
        </button>
        <span className={`text-gray-800 break-words ${task.completed ? 'line-through text-gray-500 italic' : 'font-medium'}`}>
          {task.text}
        </span>
      </div>
      <button
        onClick={() => handleDeleteTask(task.id)}
        className="ml-3 p-1 text-red-400 hover:text-red-600 rounded-full transition-colors"
        aria-label={`Delete task: ${task.text}`}
      >
        <Trash2 size={18} />
      </button>
    </div>
  );

  const DayButton = ({ day }) => (
    <button
      onClick={() => setCurrentDay(day)}
      className={`px-4 py-2 text-sm font-semibold rounded-full transition-all duration-200 whitespace-nowrap
        ${day === currentDay
          ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/50'
          : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'
        }`}
    >
      {day.substring(0, 3)}
    </button>
  );

  return (
    <div className="min-h-screen bg-gray-50 p-4 font-inter flex flex-col items-center">
      <div className="w-full max-w-xl">
        {/* Header */}
        <header className="mb-6 pt-4">
          <h1 className="text-4xl font-extrabold text-indigo-700 flex items-center mb-1">
            <Calendar className="mr-3 h-8 w-8" />
            Weekly Planner
          </h1>
          <p className="text-gray-600 ml-1">Organize your week, one task at a time.</p>
          <div className="mt-4 text-xs text-gray-500 flex items-center bg-gray-100 p-2 rounded-lg">
            <User size={14} className="mr-2 text-indigo-500"/>
            <span className="font-mono truncate" title={`User ID: ${userId}`}>
              User ID: {userId || 'Loading...'}
            </span>
            {saving && (
                <span className="ml-auto flex items-center text-indigo-600 font-semibold">
                    <Loader className="h-4 w-4 animate-spin mr-1" /> Saving...
                </span>
            )}
          </div>
        </header>
        
        {/* Error Display */}
        {firebaseError && (
            <div className="p-4 mb-6 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start shadow-md">
                <AlertTriangle size={20} className="mt-0.5 mr-3 flex-shrink-0" />
                <div>
                    <strong className="font-bold">Database Error:</strong>
                    <p className="text-sm mt-1">{firebaseError}</p>
                    <p className="text-xs italic mt-1">Data persistence may be affected.</p>
                </div>
                <button 
                    onClick={() => setFirebaseError(null)}
                    className="ml-auto text-red-500 hover:text-red-800 p-1"
                    aria-label="Dismiss error"
                >
                    <X size={16} />
                </button>
            </div>
        )}


        {/* Day Navigation */}
        <div className="mb-6 overflow-x-auto">
          <div className="flex space-x-2 pb-2">
            {WEEKDAYS.map(day => <DayButton key={day} day={day} />)}
          </div>
        </div>

        {/* Task Input Form */}
        <form onSubmit={handleAddTask} className="mb-8 bg-white p-4 rounded-xl shadow-lg border border-indigo-100">
          <h2 className="text-xl font-bold text-indigo-700 mb-3">{currentDay} Tasks</h2>
          <div className="flex gap-2">
            <input
              type="text"
              value={newTaskText}
              onChange={(e) => setNewTaskText(e.target.value)}
              placeholder={`Add a new task for ${currentDay}...`}
              className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"
              disabled={loading || !isAuthReady || saving}
            />
            <button
              type="submit"
              className="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-colors shadow-md disabled:opacity-50"
              disabled={loading || !isAuthReady || !newTaskText.trim() || saving}
              aria-label="Add Task"
            >
              <Plus size={24} />
            </button>
          </div>
        </form>

        {/* Task List */}
        <div className="pb-10">
          {loading ? (
            <div className="flex justify-center items-center py-12 text-indigo-500">
              <Loader className="w-8 h-8 animate-spin mr-3" />
              <p className="text-lg font-medium">Loading tasks...</p>
            </div>
          ) : currentTasks.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl shadow-md border border-gray-200">
              <Calendar size={48} className="mx-auto text-indigo-300 mb-3" />
              <p className="text-gray-500 font-medium">No tasks planned for {currentDay}. Get started!</p>
            </div>
          ) : (
            <div className="space-y-3">
              {currentTasks.map(task => <TaskItem key={task.id} task={task} />)}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default App;

